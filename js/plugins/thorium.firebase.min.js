/*!
 * Google Firebase functions for Thorium Mobile projects
 * Version 3.0 february, 2021
 * framework7 v5.x (https://framework7.io)
 * Google firebase (https://firebase.google.com)
 * framework7: MIT Licensed
 * Copyright 2018-2021 Thorium builder.
*/
if(firebase){var firebaseApp=firebase.initializeApp(firebaseConfig);firebaseApp?(thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase] Firebase initialized"),firebase.auth().useDeviceLanguage()):(thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase] Unable to initialize Firebase App"),app.dialog.alert("Unable to initialize Firebase App "))}else thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase] Unable to initialize Firebase"),app.dialog.alert("Unable to initialize Firebase ");var firebasePlugin={name:"Thorium Builder Firebase Plugin",bundleid:"com.thoriumbuilder.firebase",version:"2.0.0",initialized:!1,ls:null,rsp:null,rs:null,ps:null,avatarChanged:!1,token:"",firestoredb:firebase.firestore(),translatescreen:function(){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase] Translate Firebase Dialogs");var e=getLangResources().tr;$("*[data-translate]:not(input):not(textarea)").each((function(i){var a=e[$(i).attr("data-translate")];a&&(i.innerText=a)})),$("input[data-translate]").each((function(i){var a=e[$(i).attr("data-translate")];a&&(i.placeholder=a)}))},getTranslatedString:e=>getLangResources().tr[e]||null,showLoginScreen:function(e){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase] Loading Login Popup"),firebasePlugin.ls=app.loginScreen.create({el:".login-screen"}),firebasePlugin.ls.open(!0),app.emit("onShowLoginScreen",e)},showRegisterScreen:function(e){e&&e.preventDefault(),thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase] Loading Register Popup"),firebasePlugin.rs=app.popup.create({el:".register-screen",swipeToClose:!0}),firebasePlugin.rs.open(!0),app.emit("onShowRegisterScreen",e)},showResetPwScreen:function(e){e&&e.preventDefault(),thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase] Loading Reset Password Popup"),firebasePlugin.rsp=app.popup.create({el:".resetpassword-screen",swipeToClose:!0}),$(".firebase_resetpw_email").val($(".firebase_email").val()),firebasePlugin.rsp.open(!0),app.emit("onShowResetPwScreen",e)},updateUserExt:function(e){var i=firebase.auth().currentUser;if(i){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase] Updating user Information"),app.preloader.show();var a=i.uid;if(1==firebasePlugin.avatarChanged){var r=$("#firebase_profile_avatar_input").data("data-blob"),t=$("#firebase_profile_avatar_input").data("data-file").name;r.name=t;var o=(t=t.replace("C:\\fakepath\\","")).substr(t.lastIndexOf(".")+1),n=firebase.storage().ref().child(firebaseStoragePath+"/");t=a+app.utils.id("-xxxx-xxxx")+"."+o;n.child(t).put(r).catch((function(e){app.preloader.hide(),app.dialog.alert(e.message)})).then((function(e){e.task.on("state_changed",(function(e){var i=e.bytesTransferred/e.totalBytes*100;document.getElementById("firebase-upload-progress").value=i}),(function(e){app.preloader.hide(),app.dialog.alert(e.message)}),(function(){e.task.snapshot.ref.getDownloadURL().then((function(e){$(".firebase_avatar").attr("src",e),i.updateProfile({photoURL:e}).then((function(e){firebasePlugin.setUserShadow(i)})).catch((function(e){app.preloader.hide(),app.dialog.alert(e.message)}))}))}))}))}var s=$("#firebase_profile_displayname").val();i.updateProfile({displayName:s}).catch((function(e){app.preloader.hide(),app.dialog.alert(e.message)})).then((function(e){firebasePlugin.setUserShadow(i),setTimeout((function(){app.preloader.hide(),firebasePlugin.ps.close()}),1e3)}))}},setUserShadow:function(e){if(e){var i=firebasePlugin.firestoredb;if(i){var a=i.collection("thorium.users").doc(e.uid);a.get().then((function(i){if(i.exists){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase]  Update user Shadow Information");var r=e.pa||"";a.update({displayName:e.displayName,emailVerified:e.emailVerified,language:r,creationTime:e.metadata.creationTime,lastSignInTime:e.metadata.lastSignInTime,photoURL:e.photoURL,email:e.email,anonymous:e.isAnonymous}).catch((function(e){var i="[com.thoriumbuilder.firebase] Firebase Plugin: Error writing User document: "+e.message;thoriumCorePlugin.logEvent(2,i),app.dialog.alert(i)}))}else{thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase] Firebase Plugin: Create user Shadow Information");r=e.pa||"";a.set({displayName:e.displayName,emailVerified:e.emailVerified,language:r,creationTime:e.metadata.creationTime,lastSignInTime:e.metadata.lastSignInTime,photoURL:e.photoURL,email:e.email,anonymous:e.isAnonymous}).catch((function(e){var i="[com.thoriumbuilder.firebase] Error writing User document: "+e.message;thoriumCorePlugin.logEvent(2,i),app.dialog.alert(i)}))}})).catch((function(e){var i="[com.thoriumbuilder.firebase] Error getting User document: "+e.message;thoriumCorePlugin.logEvent(2,i),app.dialog.alert(i)}))}}},resizeImage:function(e,i){return thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase] Resizing Image"),new Promise((function(a,r){var t="x",o=new FileReader;o.onloadend=function(){var n=new Image;n.src=o.result,n.onload=function(){var r=n.width,o=n.height;r>o?r>i&&(o*=i/r,r=i):o>i&&(r*=i/o,o=i);var s=document.createElement("canvas");s.width=r,s.height=o,s.getContext("2d").drawImage(this,0,0,r,o);var l=e.type||"image/jpg";t=s.toDataURL(l),a(t)},n.onerror=function(e){thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase] Image Resize Error "+e),r("Image Resize Error "+e)}},o.readAsDataURL(e)}))},firebase_handleProfileImage:function(e){firebasePlugin.resizeImage(e,256).then((function(i){var a=thoriumCorePlugin.dataURItoBlob(i);a.name=i.name;var r=new FileReader;r.onload=function(i){var r=i.target.result;$(".firebase_profile_avatar").attr("src",r),$("#firebase_profile_avatar_input").data("data-file",e),$("#firebase_profile_avatar_input").data("data-blob",a),firebasePlugin.avatarChanged=!0},r.readAsDataURL(e)}))},resetPasswordExt:function(e){e.preventDefault(),thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase] Opening Reset Password Dialog");const i=firebasePlugin.getTranslatedString("resetpassword")||"Reset Password";app.dialog.confirm(i+"?",(function(){var e=$(".firebase_resetpw_email").val();e.length>0&&(app.preloader.show(),firebase.auth().sendPasswordResetEmail(e).then((function(){app.preloader.hide(),$(".firebase_email").val(e);const i=firebasePlugin.getTranslatedString("emailsent")||"an email has been sent to your address";app.dialog.alert(i),firebasePlugin.rsp.close()})).catch((function(e){app.preloader.hide(),thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase] Reset Password Error: "+e.message),app.dialog.alert(e.message)})))}))},logoutExt:function(e){app.preloader.show(),firebase.auth().signOut().then((function(){app.preloader.hide(),thoriumCorePlugin.reloadHomePage(),firebasePlugin.initialize(),app.emit("onAuthSignOut",e),thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase] Logout Command Sent")})).catch((function(e){app.preloader.hide(),thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase] Logout Error: "+e.message),app.dialog.alert(e.message)}))},signInExt:function(e){e.preventDefault(),app.preloader.show();var i=$(".firebase_email").val(),a=$(".firebase_password").val();app.preloader.show(),firebase.auth().signInWithEmailAndPassword(i,a).then((function(e){app.preloader.hide(),firebasePlugin.ls&&firebasePlugin.ls.close()})).catch((function(e){app.preloader.hide(),thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase] SignIn Error: "+e.message),app.dialog.alert(e.message)}))},createUserExt:function(e){if(e){e.user.uid;var i=$("#firebase_register_displayname").val();$("#firebase_register_displayname").val();e.user&&(e.user.updateProfile({displayName:i,photoURL:"img/defaultavatar.png"}).catch((function(e){app.preloader.hide(),thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase] Update Error: "+e.message),app.dialog.alert(e.message)})),firebasePlugin.setUserShadow(e.user),app.preloader.hide(),$("#firebase_email").val($("#firebase_register_email").val()),$("#firebase_password").val($("#firebase_register_password").val()),firebasePlugin.rs.close(),firebasePlugin.ls&&firebasePlugin.ls.close(),$(".firebase_avatar").attr("alt",i),$(".firebase_avatar").attr("title",i),thoriumCorePlugin.showNotification("Welcome "+i))}},registerExt:function(e){e.preventDefault(),app.preloader.show();var i=$("#firebase_register_email").val(),a=$("#firebase_register_password").val();if(a!=$("#firebase_register_password_verification").val()){app.preloader.hide();const e=firebasePlugin.getTranslatedString("pwmatch")||"Password does not match";return app.dialog.alert(e),thoriumCorePlugin.logEvent(1,"[com.thoriumbuilder.firebase] Password does not match"),void $("#firebase_register_password_verification").focus()}if(a.length<6){app.preloader.hide();const e=firebasePlugin.getTranslatedString("pwlength")||"Password must contain at least 6 characters";return app.dialog.alert(e),thoriumCorePlugin.logEvent(1,"[com.thoriumbuilder.firebase] Password Too Short"),void $("#firebase_register_password").focus()}app.preloader.show();var r=firebase.auth().currentUser;if(r&&1==r.isAnonymous){var t=firebase.auth.EmailAuthProvider.credential(i,a);firebase.auth().currentUser.linkWithCredential(t).catch((function(e){app.preloader.hide(),thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase] linkWithCredential Error: "+e.message),app.dialog.alert(e.message)})).then((function(e){app.preloader.hide(),firebasePlugin.createUserExt(e)}))}else firebase.auth().createUserWithEmailAndPassword(i,a).catch((function(e){app.preloader.hide(),thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase] createUserWithEmailAndPassword Error: "+e.message),app.dialog.alert(e.message)})).then((function(e){app.preloader.hide(),firebasePlugin.createUserExt(e)}))},resetRepeaters:function(){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase] no user connected, reset all Repeaters"),$(".virtual-list").each((function(e){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase] Reset Repeater with ID: ["+e.id+"]"),e.setAttribute("data-loaded","false");var i=$("#"+e.id),a=app.virtualList.get(i);a&&a.deleteAllItems()}))},handleStateChangedExt:function(e){if(app.preloader.hide(),1!=kForceInstall||0!=app.device.webView||"file:"==window.location.protocol||0!=app.device.cordova||!app.device.ios&&!app.device.android)if(e){if(e.uid==firebasePlugin.token)return;if(firebasePlugin.token=e.uid,1==e.isAnonymous&&0==firebaseAnonymous)return firebasePlugin.logoutExt(),void $(".apploader").hide();thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase] Firebase Authentification State Changed - User Connected with UID:["+e.uid+"]");e.displayName,e.email,e.emailVerified,e.photoURL,e.isAnonymous,e.uid,e.providerData;if($(".firebase-user-logout").show(),$("#firebase_login").hide(),$(".firebase_email").val(e.email),$(".firebase_displayname").text(e.displayName),1==e.isAnonymous)$(".firebase_avatar").attr("src","img/defaultavatar.png"),$(".firebase_avatar").attr("alt","anonymous"),$(".firebase_avatar").attr("title","anonymous"),thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase] Firebase Anonymous User Signed In with UID:["+e.uid+"]");else{var i=e.photoURL||"img/defaultavatar.png";$(".firebase_avatar").attr("src",i),$(".firebase_avatar").attr("alt",e.displayName),$(".firebase_avatar").attr("title",e.displayName),firebasePlugin.setUserShadow(e)}$("#view-main").show(),$(".apploader").hide(),firebasePlugin.ls&&firebasePlugin.ls.close()}else{if("none"==firebasePlugin.token)return void $(".apploader").hide();thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase] Firebase User Signed Out"),$("#auth_name").text(""),$("#auth_img").attr("src",""),$(".firebase-user-logout").hide(),$("#firebase_login").show(),$(".firebase_email").val(""),$(".firebase_displayname").text(""),$(".firebase_avatar").attr("src","img/defaultavatar.png"),$(".firebase_avatar").attr("alt",""),$(".firebase_avatar").attr("title",""),firebasePlugin.resetRepeaters(),0==firebaseAnonymous?(firebasePlugin.token="none",firebasePlugin.showLoginScreen(),setTimeout((function(){$(".apploader").hide()}),500)):firebase.auth().signInAnonymously().catch((function(e){firebasePlugin.token="none",thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase] signInAnonymously Error: "+e.message),firebasePlugin.showLoginScreen(),setTimeout((function(){$(".apploader").hide()}),500)})).then((function(e){var i=e.user;i?(firebasePlugin.token=i.uid,thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase] signInAnonymously success with uid: "+i.uid),setTimeout((function(){$(".apploader").hide()}),500)):(firebasePlugin.token="none",thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.firebase] signInAnonymously Error: "+i.uid))}))}},onFirebaseAvatarChange:function(e){e.preventDefault();var i=e.target.files[0];firebasePlugin.firebase_handleProfileImage(i)},showEditProfilePageExt:function(e){e&&e.preventDefault(),firebasePlugin.ps=app.popup.create({el:".profile-screen",swipeToClose:!1}),$(".firebase_resetpw_email").val($(".firebase_email").val());var i=firebase.auth().currentUser;if(i){firebasePlugin.ps.open(!0),$(".firebase_profile_displayname").val(i.displayName),$(".firebase_profile_email").val(i.email);var a=i.photoURL||"img/defaultavatar.png";$(".firebase_profile_avatar").attr("src",a),$(".firebase-displayname").text(i.displayName)}},facebookLoginExt:function(e){if(e&&e.preventDefault(),1==thoriumCorePlugin.isLocal()){var i="[com.thoriumbuilder.firebase] Facebook Authentification not allowed with file: protocol";return app.dialog.alert(i),void thoriumCorePlugin.logEvent(1,i)}var a=new firebase.auth.FacebookAuthProvider;a.addScope("user_birthday"),firebase.auth().signInWithPopup(a).then((function(e){e.credential.accessToken,e.user})).catch((function(e){app.preloader.hide(),app.dialog.alert(e.message)}))},googleLoginExt:function(e){if(e&&e.preventDefault(),1==thoriumCorePlugin.isLocal()){var i="[com.thoriumbuilder.firebase] Google Authentification not allowed with file: protocol";return app.dialog.alert(i),void thoriumCorePlugin.logEvent(1,i)}var a=new firebase.auth.GoogleAuthProvider;a.addScope("profile"),a.addScope("email"),firebase.auth().signInWithPopup(a).then((function(e){e.credential.accessToken,e.user})).catch((function(e){app.preloader.hide(),app.dialog.alert(e.message)}))},twitterLoginExt:function(e){if(e&&e.preventDefault(),1==thoriumCorePlugin.isLocal()){var i="[com.thoriumbuilder.firebase] Twitter Authentification not allowed with file: protocol";return app.dialog.alert(i),void thoriumCorePlugin.logEvent(1,i)}var a=new firebase.auth.TwitterAuthProvider;firebase.auth().signInWithPopup(a).then((function(e){e.credential.accessToken,e.user})).catch((function(e){app.preloader.hide(),app.dialog.alert(e.message)}))},setUserAvatar:function(e){var i=firebase.auth().currentUser;if(null!=i){var a=i.photoURL||"img/defaultavatar.png";$(".firebase_avatar").attr("src",a),$(".firebase_avatar").attr("alt",i.displayName),$(".firebase_avatar").attr("title",i.displayName)}},initialize:function(){$(".apploader").show(),firebasePlugin.translatescreen(),$(".login-screen-title").text(app.name),setTimeout((function(){$(".apploader").hide()}),2e3)},handleAvatarPopup:function(e,i){e.preventDefault();var a=firebase.auth().currentUser;if(a&&1!=a.isAnonymous){const a=e.target.getAttribute("data-page");if(a){var r=e.target.getAttribute("data-label");$("#firebasecustomprofile").attr("href","/"+a+"/"),$("#firebasecustomprofile").text(r),$("#firebasecustomprofile").show()}else $("#firebasecustomprofile").hide();app.popover.open(".firebase-popover",i,!0)}else{1==(firebaseAllowRegister||!1)&&firebasePlugin.showLoginScreen()}}};$("html").on("drop",(function(e){e.preventDefault()})),$("html").on("dragover",(function(e){e.preventDefault()})),$(document).on("dragenter",".firebase_profile_avatar",(function(e){e.preventDefault(),$(this).css("opacity","0.5"),e.stopPropagation()})),$(document).on("dragleave",".firebase_profile_avatar",(function(e){e.preventDefault(),$(this).css("opacity","1"),e.stopPropagation()})),$(document).on("drop",".firebase_profile_avatar",(function(e){e.preventDefault();var i=e.dataTransfer.files[0];$(this).css("opacity","1"),firebasePlugin.firebase_handleProfileImage(i),e.stopPropagation()})),$(document).on("click",".firebase_profile_avatar",(function(e){(e.preventDefault,1==thoriumCorePlugin.isLocal()&&(app.device.ios||app.device.android))&&app.tooltip.create({targetEl:$(this),text:"Drop your file here"}).show();$(".firebase_profile_avatar_input").trigger("click")})),$(document).on("change",".firebase_profile_avatar_input",(function(e){firebasePlugin.onFirebaseAvatarChange(e)})),$(document).on("submit",".firebase-signin-form",(function(e){firebasePlugin.signInExt(e)})),$(document).on("click",".firebase_register",(function(e){firebasePlugin.showRegisterScreen(e)})),$(document).on("click",".firebase_resetpasswword",(function(e){firebasePlugin.showResetPwScreen(e)})),$(document).on("click",".firebase_editprofile",(function(e){firebasePlugin.showEditProfilePageExt(e)})),$(document).on("click",".firebase-user-logout",(function(e){e.preventDefault();const i=firebasePlugin.getTranslatedString("logout")||"Logout";app.dialog.confirm(i+"?",(function(){firebasePlugin.logoutExt()}))})),$(document).on("click",".firebase_fb_login",(function(e){firebasePlugin.facebookLoginExt(e)})),$(document).on("click",".firebase_google_login",(function(e){firebasePlugin.googleLoginExt(e)})),$(document).on("click",".firebase_twitter_login",(function(e){firebasePlugin.twitterLoginExt(e)})),$(document).on("click",".firebase_avatar",(function(e){firebasePlugin.handleAvatarPopup(e,$(this))})),$(document).on("click",".resetpassword-submit",(function(e){e.preventDefault,1==document.getElementById("firebase-resetpw-form").checkValidity()&&firebasePlugin.resetPasswordExt(e)})),$(document).on("click",".submit_firebase-profile",(function(e){e.preventDefault,firebasePlugin.updateUserExt(e)})),$(document).on("click",".submit_firebase-register",(function(e){e.preventDefault,firebasePlugin.registerExt(e)})),$(document).on("input",".firebase_profile_displayname",(function(e){$(".firebase-displayname").text($(".firebase_profile_displayname").val())})),window.onerror=function(e,i,a){return thoriumCorePlugin.logEvent(2,"[com.thoriumbuilder.core] An error occured: "+e+"url="+i+" line"+a),!1},$(document).on("page:init",(function(e){firebasePlugin.setUserAvatar(e)})),firebase.auth().onAuthStateChanged((function(e){var i;app.emit("onAuthStateChanged",e),i=e?(e.isAnonymous=!0)?"Anonymous":e.displayName:"no session",thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firebase] onAuthStateChanged ["+i+"]"),firebasePlugin.handleStateChangedExt(e),"undefined"!=typeof googleMapPlugin&&googleMapPlugin.initializePlugin(),"undefined"!=typeof firestorePlugin&&e&&($(".firebase-single-form").each((function(e){firestorePlugin.singleRecordFormInit(e)})),1==e.isAnonymous&&0==firebaseAnonymous?thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firestore] Current User is Anonymous"):(firestorePlugin.firebase_initFirebaseVirtualLists(!0),firestorePlugin.firebase_initFirebaseDisplayers(!0),"undefined"!=typeof openStreetMapPlugin&&(thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.firestore] openStreetMapPlugin detected, initializing Maps"),setTimeout((function(){openStreetMapPlugin.reloadAllMaps()}),100))))})),document.addEventListener("deviceready",firebasePlugin.initialize),document.addEventListener("DOMContentLoaded",firebasePlugin.initialize);