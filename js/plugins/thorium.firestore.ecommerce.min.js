/*!
 * Thorium Builder eCommerce Plugin for Google cloud.firestore
 * Version 2.0.0 june, 2020
 * framework7 v5.x (https://framework7.io)
 * Google firebase (https://firebase.google.com)
 * framework7: MIT Licensed
 * Copyright 2018-2020 Thorium builder.
*/
var eCommerceFirestorePlugin={name:"Thorium Builder eCommerce Plugin for Google cloud.firestore",bundleid:"com.thoriumbuilder.ecommerce",version:"2.0.0",shoppingCartPopup:null,productstotal:0,deliveryfees:0,changeCartQuantity:function(e){app.preloader.show();var r=e.el.getAttribute("data-object-id"),t=parseInt(e.value),o=firebase.auth().currentUser,i=firestoredb.collection("thorium.shoppingcart").doc(o.uid);i.get().then((function(e){if(e.exists){var o=e.data();if(o){var a=0;for(var n in o){var p=o[n];if("object"==typeof p&&null!==p){var l=p.price.trim();if(l=l.replaceAll(",","."),p.objectid==r){var c=parseFloat(l)*t;a+=c}else{c=parseFloat(l)*parseInt(p.qty);a+=c}}}var u=o[r],m=Date.now(),s=o.totalqty||0,d=parseInt(u.qty)||0;u.qty=t,s=s+t-d,a=a.toFixed(2),eCommerceFirestorePlugin.productstotal=a;var g=parseFloat($(".shoppingcartpopup").attr("data-delivery")||0);g=g.toFixed(2);var h=parseFloat(a)+parseFloat(g);h=h.toFixed(2),i.update({[r]:u,modifieddate:m,totalqty:s,productstotal:a,ordertotal:h}).catch((function(e){app.preloader.hide();var r="FireStore Plugin: "+e.message;thoriumCorePlugin.logEvent(2,r),app.emit("onFirestoreUpdateError",$(this),e),app.dialog.alert(r)})).then((function(e){app.preloader.hide();var r="FireStore Plugin: Shopping Cart Updated - Qty changed to "+t;thoriumCorePlugin.logEvent(0,r),$(".shoppingcartcounter").text(s);var o=$(".shoppingcartpopup").attr("data-currency-symbol"),i="true"==$(".shoppingcartpopup").attr("data-symbol-left"),n=(parseFloat(a)+parseFloat(eCommerceFirestorePlugin.deliveryfees)).toFixed(2);1==i?$(".shoppingcarttotal").text(o+n):$(".shoppingcarttotal").text(n+o),0==parseFloat(a)?$("#shoppingcartbutton1").addClass("disabled"):$("#shoppingcartbutton1").removeClass("disabled")}))}}}))},getCustomerInformation:function(e){var r=firebase.auth().currentUser;if(!r)return thoriumCorePlugin.logEvent(0,"FireStore Plugin: Shopping Cart not Allowed for Anonymous users"),void app.dialog.alert("You must SignIn first!");if(1==("true"==document.getElementById("shoppingcartform").getAttribute("data-loaded")))return app.tab.show("#shoppingCartTab2",!0),void $("#shoppingcartpopup-content").scrollTop(0,0);var t="false"==$(".shoppingcartpopup").attr("data-address-pane")||!1;app.preloader.show(),thoriumCorePlugin.logEvent(0,"Firebase eCommerce Plugin: get User information"),document.getElementById("shoppingcartform").setAttribute("data-loaded",!0),firestoredb.collection("thorium.users").doc(r.uid).get().then((function(o){if(o.exists){var i=o.data();thoriumCorePlugin.logEvent(0,"Firebase eCommerce Plugin: User Firebase data loaded"),$('#shoppingcartform input[name="shoppingcart-fullname"]').val(i.fullname);var a=i.orderemail;a||(a=i.email),$('#shoppingcartform input[name="shoppingcart-email"]').val(a),$('#shoppingcartform textarea[name="shoppingcart-address"]').val(i.address),$('#shoppingcartform input[name="shoppingcart-zipcode"]').val(i.zipcode),$('#shoppingcartform input[name="shoppingcart-city"]').val(i.city),$('#shoppingcartform input[name="shoppingcart-country"]').val(i.country),$('#shoppingcartform textarea[name="shoppingcart-notes"]').val(i.notes),app.preloader.hide(),1==t?(app.tab.show("#shoppingCartTab3",!0),eCommerceFirestorePlugin.processOrderPayment(e)):app.tab.show("#shoppingCartTab2",!0),$("#shoppingcartpopup-content").scrollTop(0,0)}else thoriumCorePlugin.logEvent(0,"Firebase eCommerce Plugin: User Record not exists, will be created"),app.preloader.hide(),firebasePlugin.setUserShadow(r),1==t?(app.tab.show("#shoppingCartTab3",!0),eCommerceFirestorePlugin.processOrderPayment(e)):app.tab.show("#shoppingCartTab2",!0)})).catch((function(e){app.preloader.hide();var r="FireStore Plugin: Shopping Cart Error "+e.message;thoriumCorePlugin.logEvent(2,r),app.emit("onFirestoreInsertError",$(this),e),app.dialog.alert(r)}))},setCustomerInformation:function(e){var r=firebase.auth().currentUser;if(!r)return thoriumCorePlugin.logEvent(0,"FireStore Plugin: Shopping Cart not Allowed for Anonymous users"),void app.dialog.alert("You must SignIn first!");app.preloader.show();var t=firestoredb.collection("thorium.users").doc(r.uid);t.get().then((function(o){if(o.exists){var i={};i.fullname=$('#shoppingcartform input[name="shoppingcart-fullname"]').val()||"",i.orderemail=$('#shoppingcartform input[name="shoppingcart-email"]').val()||"",i.address=$('#shoppingcartform textarea[name="shoppingcart-address"]').val()||"",i.zipcode=$('#shoppingcartform input[name="shoppingcart-zipcode"]').val()||"",i.city=$('#shoppingcartform input[name="shoppingcart-city"]').val()||"",i.country=$('#shoppingcartform input[name="shoppingcart-country"]').val()||"",i.notes=$('#shoppingcartform textarea[name="shoppingcart-notes"]').val()||"",i.anonymous=r.isAnonymous,t.update({fullname:i.fullname,orderemail:i.orderemail,address:i.address,zipcode:i.zipcode,city:i.city,country:i.country,notes:i.notes,anonymous:i.anonymous}).catch((function(r){app.preloader.hide();var t="FireStore eCommerce Plugin: "+r.message;thoriumCorePlugin.logEvent(2,t),app.emit("onFirestoreUpdateError",e.target,r),app.dialog.alert(t)})).then((function(e){app.preloader.hide();thoriumCorePlugin.logEvent(0,"FireStore eCommerce Plugin: Customer Address Updated for user UID="+r.uid),app.tab.show("#shoppingCartTab3",!0),$("#shoppingcartpopup-content").scrollTop(0,0)}))}})).catch((function(e){app.preloader.hide();var r="FireStore Plugin: Shopping Cart Error "+e.message;thoriumCorePlugin.logEvent(2,r),app.emit("onFirestoreInsertError",$(this),e),app.dialog.alert(r)}))},openCart:function(e){var r=firebase.auth().currentUser;if(r){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] Loading Shopping Cart"),app.tab.show("#shoppingCartTab1",!0);var t=$(".shoppingcartpopup").attr("data-currency-symbol"),o="true"==$(".shoppingcartpopup").attr("data-symbol-left"),i=parseFloat($(".shoppingcartpopup").attr("data-delivery")||0);i=i.toFixed(2),firestoredb.collection("thorium.shoppingcart").doc(r.uid).get().then((function(e){if(e.exists){app.preloader.show(),thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] Shopping Cart Firebase Record Loaded");var r=e.data(),a="",n=$(".shoppingcart-template").html();thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] Loading Shopping Cart Item Lines");var p=r.productstotal||"0.00",l=r.ordertotal||"0.00";for(var c in r){var u=r[c];if("object"==typeof u&&null!==u){var m=n;for(var s in u)m=m.replaceAll("{title}",u.name),m=(m=(m=(m=1==o?m.replaceAll("{price}",t+u.price):m.replaceAll("{price}",u.price+t)).replaceAll("{qty}",u.qty)).replaceAll("{objectid}",u.objectid)).replaceAll("{image}","background-image:url('"+u.image+"');");a+=m}}eCommerceFirestorePlugin.shoppingCartPopup=app.popup.create({el:".shoppingcartpopup",swipeToClose:!1}),eCommerceFirestorePlugin.shoppingCartPopup.open(!0),$("#shoppingcartcontents").html(a),0==i?$(".deliveryblock").hide():(1==o?$(".shoppingcartdelivery").text(t+i):$(".shoppingcartdelivery").text(i+t),eCommerceFirestorePlugin.deliveryfees=i),1==o?$(".shoppingcarttotal").text(t+l):$(".shoppingcarttotal").text(l+t),eCommerceFirestorePlugin.productstotal=p,0==parseFloat(p)?$("#shoppingcartbutton1").addClass("disabled"):$("#shoppingcartbutton1").removeClass("disabled"),thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] Initialize Steppers"),$(".stepper-shoppingcart").each((function(e,r){var t=parseInt(r.getAttribute("data-value"))||0;app.stepper.create({el:r,step:1,min:0,max:100,value:t,on:{change:function(e){eCommerceFirestorePlugin.changeCartQuantity(e)}}})})),app.preloader.hide()}else thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] Shopping Cart is Empty "),app.preloader.hide()})).catch((function(e){app.preloader.hide();var r="[com.thoriumbuilder.ecommerce] Shopping Cart Error "+e.message;thoriumCorePlugin.logEvent(2,r),app.emit("onFirestoreInsertError",$(this),e),app.dialog.alert(r)}))}else thoriumCorePlugin.logEvent(1,"[com.thoriumbuilder.ecommerce] User is not Connected")},setCartCounter:function(){var e=$(".shoppingcartcounter");if(e&&0!=e.length){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] Get Shopping Cart Item Count");var r=firebase.auth().currentUser;firestoredb.collection("thorium.shoppingcart").doc(r.uid).get().then((function(r){if(r.exists){var t;t=r.data().totalqty,e.text(t)}else e.text("0")})).catch((function(e){app.preloader.hide();var r="[com.thoriumbuilder.ecommerce] Shopping Cart Counter Calcul Error "+e.message;thoriumCorePlugin.logEvent(2,r),app.emit("onFirestoreInsertError",$(this),e),app.dialog.alert(r)}))}},clearShoppingCart:function(e){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] Clear Shopping Cart");var r=firebase.auth().currentUser;firestoredb.collection("thorium.shoppingcart").doc(r.uid).delete().then((function(){eCommerceFirestorePlugin.shoppingCartPopup&&(eCommerceFirestorePlugin.shoppingCartPopup.close(),$(".shoppingcartcounter").text("0"))})).catch((function(e){app.preloader.hide();var r="[com.thoriumbuilder.ecommerce] Shopping Cart Delete Error "+e.message;thoriumCorePlugin.logEvent(2,r),app.emit("onFirestoreInsertError",$(this),e),app.dialog.alert(r)}))},addITemToCart:function(e){var r=e.target,t=r.getAttribute("data-confirmation"),o=firebase.auth().currentUser;if(0==(r.getAttribute("data-allow-anonymous")||null)&&(!o||1==o.isAnonymous))return app.preloader.hide(),thoriumCorePlugin.logEvent(1,"FireStore Plugin: Shopping Cart not Allowed for Anonymous users"),void app.dialog.alert("You must SignIn first!");thoriumCorePlugin.logEvent(0,"Firebase eCommerce Plugin: Add Item to Shopping Cart");var i=$("#"+r.id).closest(".firebase-virtual-list-content")||null,a=!0;if(!i||0==i.length){if(!(i=$("#"+r.id).closest(".firebase-form")||null)||0==i.length){app.preloader.hide();var n="[com.thoriumbuilder.ecommerce] Parent Repeater/Displayer not found";return thoriumCorePlugin.logEvent(2,n),void app.dialog.alert(n)}a=!1}var p=i.attr("data-collection");if(!p){app.preloader.hide();n="FireStore Plugin: Collection not Set";return thoriumCorePlugin.logEvent(2,n),void app.dialog.alert(n)}var l,c=r.getAttribute("data-index")||null;if(!c){app.preloader.hide();n="[com.thoriumbuilder.ecommerce] Unable to get Item line index";return thoriumCorePlugin.logEvent(2,n),void app.dialog.alert(n)}1==a?l=app.virtualList.get("#"+i[0].id).items[c]:l=$("#"+i[0].id).data("record");if(!l){app.preloader.hide();n="[com.thoriumbuilder.ecommerce] Unable to get Item line Data";return thoriumCorePlugin.logEvent(2,n),void app.dialog.alert(n)}var u=r.getAttribute("data-image-field")||null,m=r.getAttribute("data-name-field")||null,s=r.getAttribute("data-price-field")||null;app.preloader.show();var d=r.getAttribute("data-key")||null,g={},h=Date.now();if(g.addeddate=h,g.objectid=d,g.collection=p,u&&l.hasOwnProperty(u)?g.image=l[u]:g.image="/img/defaultimg.png",m&&l.hasOwnProperty(m)?g.name=l[m]:g.name="No Name",!m||!l.hasOwnProperty(s)){app.preloader.hide();n="[com.thoriumbuilder.ecommerce] Price Field Not Set";return thoriumCorePlugin.logEvent(2,n),void app.dialog.alert(n)}var v=l[s];v=v.replaceAll(",","."),g.price=v;var f=0,C=g.objectid;const b=firebase.firestore.FieldValue.increment(1);var P=firestoredb.collection("thorium.shoppingcart").doc(o.uid);P.get().then((function(e){if(e.exists){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] Update Shopping Cart Firebase Record");var r=e.data();thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] Recalculate Total Price");var i=0;for(var a in r){var n=r[a];if("object"==typeof n&&null!==n){var p=n.price.trim();p=p.replaceAll(",","."),i+=parseFloat(p)*parseInt(n.qty)}}i=(i=parseFloat(i)+parseFloat(g.price)).toFixed(2);var l=parseFloat($(".shoppingcartpopup").attr("data-delivery")||0).toFixed(2);eCommerceFirestorePlugin.deliveryfees=l,u=(u=parseFloat(l)+parseFloat(i)).toFixed(2),eCommerceFirestorePlugin.productstotal=u;var c=r[g.objectid];g.qty=c?r[g.objectid].qty+1:1,f=r.totalqty+1,P.update({totalqty:b,modifieddate:h,productstotal:i,ordertotal:u,delivery:l,[C]:g}).catch((function(e){app.preloader.hide();var r="[com.thoriumbuilder.ecommerce] "+e.message;thoriumCorePlugin.logEvent(2,r),app.emit("onFirestoreInsertError",$(this),e),app.dialog.alert(r)})).then((function(e){app.preloader.hide();var r="[com.thoriumbuilder.ecommerce] Shopping Cart Updated - Qty increased to "+f;thoriumCorePlugin.logEvent(0,r),$(".shoppingcartcounter").text(f),$(".shoppingcartcounter").show(),t&&thoriumCorePlugin.showToast(t)}))}else{g.qty=1,f=1;var u;l=parseFloat($(".shoppingcartpopup").attr("data-delivery")||0).toFixed(2);eCommerceFirestorePlugin.deliveryfees=l,u=(u=parseFloat(l)+parseFloat(g.price)).toFixed(2),eCommerceFirestorePlugin.productstotal=g.price,P.set({totalqty:1,createddate:h,modifieddate:h,createdby:o.uid,productstotal:g.price,ordertotal:u,delivery:l,[C]:g}).catch((function(e){app.preloader.hide();var r="[com.thoriumbuilder.ecommerce] Shopping Cart Error "+e.message;thoriumCorePlugin.logEvent(2,r),app.emit("onFirestoreInsertError",$(this),e),app.dialog.alert(r)})).then((function(e){eCommerceFirestorePlugin.productstotal=g.price,app.preloader.hide();var r="[com.thoriumbuilder.ecommerce] Shopping Cart Created - Qty increased to "+f;thoriumCorePlugin.logEvent(0,r),$(".shoppingcartcounter").text(f),t&&thoriumCorePlugin.showToast(t)}))}})).catch((function(e){app.preloader.hide();var r="[com.thoriumbuilder.ecommerce] Shopping Cart Error "+e.message;thoriumCorePlugin.logEvent(2,r),app.emit("onFirestoreInsertError",$(this),e),app.dialog.alert(r)}))},ConvertCartToHistory:function(e){var r=firebase.auth().currentUser;if(!r)return thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] user is not connected"),void app.dialog.alert("You must SignIn first!");thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] Loading Shopping Cart");var t=firestoredb.collection("thorium.shoppingcart").doc(r.uid);t.get().then((function(e){if(e.exists){if(e.exists){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] Shopping Cart Firebase Record Loaded");var o=e.data();thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] Create Firestore Batch");var i=firestoredb.batch(),a=firestoredb.collection("thorium.orders").doc(),n=a.id;i.set(a,{orderid:n,createdby:o.createdby,createdbyname:r.displayName,createdbyemail:r.email,createdbyphotourl:r.photoURL,createddate:o.createddate,modifieddate:o.modifieddate,productstotal:o.productstotal,totalqty:o.totalqty,ordertotal:o.ordertotal,delivery:o.delivery});var p="[com.thoriumbuilder.ecommerce] Order Created with ID "+n;for(var l in thoriumCorePlugin.logEvent(0,p),$(".shoppingcartcounter").text("0"),thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] Saving Order Lines"),o){var c=o[l];if("object"==typeof c&&null!==c){var u=firestoredb.collection("thorium.order.lines").doc(),m=u.id;thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] Saving Order Line with ID ["+m+"]"),i.set(u,{parentuid:n,addeddate:c.addeddate,collection:c.collection,image:c.image,name:c.name,objectid:c.objectid,price:c.price,qty:c.qty})}}i.delete(t),i.commit().then((function(){eCommerceFirestorePlugin.productstotal=0,eCommerceFirestorePlugin.deliveryfees=0,thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] Batch Transaction successfully executed")})).catch((function(e){thoriumCorePlugin.logEvent(2,e)}))}}else thoriumCorePlugin.logEvent(1,"[com.thoriumbuilder.ecommerce] Shopping cart is Empty")})).catch((function(e){app.preloader.hide();var r="[com.thoriumbuilder.ecommerce] Unable to get Shopping Cart content. error  "+e.message;return thoriumCorePlugin.logEvent(2,r),app.emit("onFirestoreInsertError",$(this),e),app.dialog.alert(r),Promise.reject(r)}))},paymentCallback:function(e){app.tab.show("#shoppingCartTab4",!0)},processOrderPayment:function(e){if(0!=eCommerceFirestorePlugin.productstotal){var r=$(".shoppingcartpopup").attr("data-payment-provider")||null,t="true"==$(".shoppingcartpopup").attr("data-skip-payment")||!1;if(r&&0!=r.length||0!=t)if(1!=t){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] Send Shopping Cart to Provider "+r);var o=window[r];if(!o){a="[com.thoriumbuilder.ecommerce] Payment JS Function '"+r+"' not implemented";return thoriumCorePlugin.logEvent(2,a),void $(".paymentprocessor").html("<h4>Payment Gateway ["+r+"] not set</h4>")}thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] Get data for processing payment with provider "+r);var i=firebase.auth().currentUser;firestoredb.collection("thorium.shoppingcart").doc(i.uid).get().then((function(e){if(e.exists){var t=e.data();thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] Call Function "+r),o.price=t.productstotal,o.createdby=t.createdby,o.createddate=t.createddate,o.qty=t.totalqty,o.fullname=$('#shoppingcartform input[name="shoppingcart-fullname"]').val(),o.address=$('#shoppingcartform textarea[name="shoppingcart-address"]').val(),o.zipcode=$('#shoppingcartform input[name="shoppingcart-zipcode"]').val(),o.email=$('#shoppingcartform input[name="shoppingcart-email"]').val(),o.city,$('#shoppingcartform input[name="shoppingcart-city"]').val(),o.country=$('#shoppingcartform input[name="shoppingcart-country"]').val(),o.notes=$('#shoppingcartform textarea[name="shoppingcart-notes"]').val(),o.initialize()}})).catch((function(e){app.preloader.hide();var r="[com.thoriumbuilder.ecommerce] Shopping Cart Error "+e.message;thoriumCorePlugin.logEvent(2,r),app.emit("onFirestoreInsertError",$(this),e),app.dialog.alert(r)}))}else $(".saveorderbtn").show();else{$(".paymentprocessor").html("<h4>Payment Gateway not set</h4>");var a="[com.thoriumbuilder.ecommerce] Payment Provider not set";thoriumCorePlugin.logEvent(2,a)}}else{var a="[com.thoriumbuilder.ecommerce] Shopping Cart Error: total is zero";thoriumCorePlugin.logEvent(1,a)}}};$(document).on("click",".firebase-shopping-cart",(function(e){e.preventDefault(),eCommerceFirestorePlugin.addITemToCart(e)})),$(document).on("click",".shoppingcartcontroller",(function(e){e.preventDefault(),eCommerceFirestorePlugin.openCart(e)})),$(document).on("click",".shoppingcart-clear",(function(e){e.preventDefault(),app.dialog.confirm("Clear Shopping cart?",(function(){eCommerceFirestorePlugin.clearShoppingCart()}))})),$(document).on("click","#shoppingcartbutton1",(function(e){e.preventDefault(),eCommerceFirestorePlugin.getCustomerInformation(e)})),$(document).on("click","#shoppingcartbutton2",(function(e){e.preventDefault(),app.tab.show("#shoppingCartTab1",!0)})),$(document).on("click",".saveorderbtn",(function(e){e.preventDefault(),app.preloader.show(),eCommerceFirestorePlugin.ConvertCartToHistory(),eCommerceFirestorePlugin.shoppingCartPopup&&setTimeout((function(){app.preloader.hide(),eCommerceFirestorePlugin.paymentCallback()}),1e3)})),$(document).on("click","#shoppingcartbutton3",(function(e){e.preventDefault(),1==document.getElementById("shoppingcartform").checkValidity()?(eCommerceFirestorePlugin.setCustomerInformation(e),$("#paypalform").hide(),eCommerceFirestorePlugin.processOrderPayment(e)):thoriumCorePlugin.logEvent(1,"[com.thoriumbuilder.ecommerce] Missing mandatory fields")})),$(document).on("page:mounted",(function(e){firebase.auth().currentUser&&eCommerceFirestorePlugin.setCartCounter()})),firebase.auth().onAuthStateChanged((function(e){thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] Firebase User Changed"),e?($(".shoppingcartcontroller").removeClass("disabled"),eCommerceFirestorePlugin.setCartCounter()):(thoriumCorePlugin.logEvent(0,"[com.thoriumbuilder.ecommerce] No user connected, disable Shopping Cart Controller"),$(".shoppingcartcontroller").addClass("disabled"),$(".shoppingcartcounter").text("0"))}));